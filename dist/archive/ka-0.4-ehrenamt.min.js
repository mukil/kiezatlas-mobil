/** 
 * This is some KiezatlasJS citymap client designed to run on all major mobile screens.
 * @author  Malte Rei&szlig;ig (rma@mikromedia.de), Copyright (c) 2012
 * @license   GPLv3 (http://www.gnu.org/licenses/gpl-3.0.en.html)
 * 
 * @requires  jQuery JavaScript Library v1.5.2, Copyright 2011, John Resig
              Dual licensed under the MIT or GPL Version 2 licenses.(http://jquery.org/license)
 * @requires  leaflet.js, Copyright (c) 2010-2012, CloudMade, Vladimir Agafonkin, All rights reserved.
 *            Used in version/with source code at https://github.com/mukil/Leaflet
 * @requires  iscroll.js v4.1.9 ~ Copyright (c) 2011 Matteo Spinelli, http://cubiq.org
 *            Released under MIT license, (http://cubiq.org/license)
* 
 * @modified  02.July 2012
 */var SERVER_URL="http://www.kiezatlas.de",SERVICE_URL=SERVER_URL+"/rpc/",ICONS_URL="http://www.kiezatlas.de/client/icons/",IMAGES_URL="http://www.kiezatlas.de/client/images/",baseUrl=SERVER_URL+"/ehrenamt-mobile/",permaLink="",linkParams=[],kiezatlas=new function(){this.mapTopics=undefined,this.workspaceCriterias=undefined,this.cityMapId=undefined,this.workspaceId=undefined,this.defaultMapCenter=undefined,this.markersBounds=undefined,this.locationCircle=undefined,this.mapLayer=undefined,this.map=undefined,this.serverUrl=undefined,this.serviceUrl=undefined,this.iconsFolder=undefined,this.imagesFolder=undefined,this.markers=undefined,this.LEVEL_OF_DETAIL_ZOOM=15,this.LEVEL_OF_STREET_ZOOM=14,this.LEVEL_OF_KIEZ_ZOOM=13,this.LEVEL_OF_DISTRICT_ZOOM=12,this.LEVEL_OF_CITY_ZOOM=11,this.layer=undefined,this.historyApiSupported=window.history.pushState,this.panoramaOrientation=undefined,this.myScroll=undefined,this.renderSite=function(){var a='<a class="leaflet-control-zoom-loc" href="#" title="Your Location"></a>',b='<a id="go-more" title="Bezirksauswahl" alt="Bezirksauswahl"href="#"></a>';kiezatlas.map.on("locationfound",kiezatlas.onLocationFound),kiezatlas.map.on("locationerror",kiezatlas.onLocationError),jQuery(a).insertBefore(".leaflet-control-zoom-in"),jQuery(b).insertBefore(".leaflet-control-zoom-loc"),jQuery(".leaflet-control-zoom-loc").click(kiezatlas.getUsersLocation),jQuery("a#go-more").click(kiezatlas.showKiezatlasControl),jQuery(window).resize(kiezatlas.handleOrientationChange),kiezatlas.hideAddressBarThroughScrolling()},this.executeBrowserSpecificCrap=function(){var a=document.getElementsByTagName("head")[0],b=document.createElement("style");navigator.userAgent.indexOf("Fennec")!=-1?b.innerHTML="@media only screen { #top-button { display: none !important; } #go-more { background-position: 30px 10px; } }":navigator.userAgent.indexOf("WebKit")!=-1&&navigator.userAgent.indexOf("Android")!=-1?b.innerHTML="@media only screen { #go-more { background-position: 30px 12px !important;} }":navigator.userAgent.indexOf("Opera")!=-1&&(b.innerHTML="@media only screen { #go-more { background-position: 30px 12px !important;} }"),a.appendChild(b)},this.loadCityMap=function(a,b){kiezatlas.cityMapId=a,kiezatlas.workspaceId=b,kiezatlas.markers!=undefined&&kiezatlas.clearMarkers(),jQuery("img.loading").css("display","block"),kiezatlas.loadCityMapTopics(a,b,function(){kiezatlas.setupLeafletMarkers(),kiezatlas.setToCurrentBounds(),kiezatlas.getUsersLocation()}),kiezatlas.closeInfoContainer(),cityMapEhrenamtId!=undefined&&cityMapEventId!=undefined&&(kiezatlas.cityMapId==cityMapEhrenamtId?(jQuery("#go-do").addClass("selected"),jQuery("#go-event").removeClass("selected")):kiezatlas.cityMapId==cityMapEventId&&(jQuery("#go-event").addClass("selected"),jQuery("#go-do").removeClass("selected"))),kiezatlas.hideKiezatlasControl()},this.loadCityMapTopics=function(a,b,c){var d=baseUrl+"proxies/getCityMap.php?mapId="+a+"&workspaceId="+b,e='{"method": "getMapTopics", "params": ["'+a+'" , "'+b+'"]}';jQuery.ajax({type:"GET",async:!1,url:d,dataType:"json",beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")},success:function(a){kiezatlas.setMapTopics(a),c()},error:function(a,b,c){throw new Error("Error while loading city-map. Message: "+JSON.stringify(a))}})},this.info=function(a){kiezatlas.loadCityObjectInfo(a,kiezatlas.renderInfo)},this.loadCityObjectInfo=function(a,b){var c=baseUrl+"proxies/getGeoObjectInfo.php?topicId="+a;kiezatlas.showDetailsProgressBar(),jQuery.ajax({type:"GET",async:!1,url:c,dataType:"json",beforeSend:function(a){a.setRequestHeader("Content-Type","application/json")},success:function(a){b(a.result)},error:function(a,b,c){throw new Error("ERROR: detailed information on this point could not be loaded. please try again. "+a)}})},this.showDetailsProgressBar=function(){jQuery("#scroller").empty();var a='<div id="loading-area"><img src="css/pacman.gif" class="loading">&nbsp;o0( ... data )</div>';kiezatlas.showInfoContainer(),jQuery("#info-container").append(a)},this.hideDetailsProgressBar=function(){jQuery("#loading-area").remove()},this.renderInfo=function(a){jQuery("#close-button").show(),jQuery("#down-button").show();var b='<div id="info-table">';b+='<h3 class="title">'+a.name+"</h3></div>";var c="",d=kiezatlas.getTopicAddress(a),e=kiezatlas.getTopicPostalCode(a),f=kiezatlas.getTopicCity(a),g=kiezatlas.getLatLng(a);f==undefined&&(f="Berlin");if(f==" Berlin"||f=="Berlin"){var h=d+"%20"+e+"%20"+f,i="http://www.fahrinfo-berlin.de/fahrinfo/bin/query.exe/d?Z="+h+"&REQ0JourneyStopsZA1=2&start=1",j='<a href="'+i+'" target="_blank">'+'<img class="fahrinfo" src="'+kiezatlas.imagesFolder+'fahrinfo.gif" border="0" hspace="20"/></a>';c='<div id="info-item"><span class="content">'+d+", "+e+" "+f+j+"</span><br/>"}else c='<div id="info-item"><span class="content">'+d+", "+e+" "+f+"</span><br/>";a=kiezatlas.stripFieldsContaining(a,"LAT"),a=kiezatlas.stripFieldsContaining(a,"LONG"),a=kiezatlas.stripFieldsContaining(a,"Locked Geometry"),a=kiezatlas.stripFieldsContaining(a,"Forum / Aktivierung"),a=kiezatlas.stripFieldsContaining(a,"Image"),a=kiezatlas.stripFieldsContaining(a,"Icon"),a=kiezatlas.stripFieldsContaining(a,"YADE"),a=kiezatlas.stripFieldsContaining(a,"Name"),a=kiezatlas.stripFieldsContaining(a,"Description"),a=kiezatlas.stripFieldsContaining(a,"Timestamp"),a=kiezatlas.stripFieldsContaining(a,"OriginId"),a=kiezatlas.stripFieldsContaining(a,"Administrator Infos"),a=kiezatlas.stripFieldsContaining(a,"Address"),a=kiezatlas.stripFieldsContaining(a,"Stadt");var k="";for(var l=0;l<a.properties.length;l++){a.properties[l].label.indexOf("Sonstiges")==-1&&a.properties[l].label.indexOf("Administrator")==-1&&(a.properties[l].label!="Barrierefrei"||a.properties[l].value!="")&&a.properties[l].value!=""&&(k+="<br/>"+a.properties[l].label+":&nbsp;");if(a.properties[l].type==0)a.properties[l].label.indexOf("Barrierefrei")==-1?k+="<b>"+a.properties[l].value+"</b>":a.properties[l].value!=""&&(a.properties[l].value=="Ja"?k+="<b>Ja Rollstuhlgerecht</b></p>":a.properties[l].value.indexOf("Eingeschr")!=-1?k+="<b>Eingeschr&auml;nkt Rollstuhlgerecht</b></p>":a.properties[l].value=="Nein"?k+="<b>Nicht Rollstuhlgerecht</b></p>":k+="<b>"+a.properties[l].value+"</b><p/>");else{var m="";k+="";for(var n=0;n<a.properties[l].values.length;n++)value=a.properties[l].values[n].name,a.properties[l].name=="Person"?k+="<b>"+value+"</b>&nbsp;":a.properties[l].name=="Webpage"?(value=kiezatlas.makeEhrenamtsLink(value,value),k+="<b>"+value+"</b>&nbsp;"):k+="<b>"+value+"</b>&nbsp;";k+="<br/>"}}c+=k,c+="</p></div>",jQuery("#scroller").html(b),jQuery("#scroller").append(c),kiezatlas.hideDetailsProgressBar(),kiezatlas.myScroll!=undefined&&(kiezatlas.myScroll.destroy(),kiezatlas.myScroll=null),kiezatlas.map.panTo(g)},this.showInfoContainer=function(){jQuery("#info-container").hide(),jQuery("#top-button").hide(),jQuery("#navigation").hide(),jQuery(".leaflet-control-zoom.leaflet-control").css("margin-top",0),kiezatlas.handleOrientationChange(),jQuery("#map").removeClass("fullsize"),kiezatlas.map.invalidateSize(),jQuery("#info-container").click(function(a){a.stopPropagation()}),jQuery("#info-container").show()},this.closeInfoContainer=function(){jQuery("#navigation").show(),jQuery(".leaflet-control-zoom.leaflet-control").css("margin-top",50),kiezatlas.handleOrientationChange(),jQuery("#map").addClass("fullsize"),kiezatlas.map.invalidateSize(),jQuery("#info-container").hide()},this.scrollInfoDown=function(){kiezatlas.myScroll.scrollTo(0,75,200,!0)},this.scrollInfoTop=function(){kiezatlas.myScroll.scrollTo(0,0,200,!0)},this.toggleInfoItem=function(a){var b=a.currentTarget.offsetParent.children[2].id;jQuery("#"+b).toggle()},this.setupLeafletMarkers=function(){var a=L.Icon.extend({options:{iconUrl:"css/locationPointer.png",shadowUrl:null,iconSize:new L.Point(40,40),shadowSize:null,iconAnchor:new L.Point(20,14),popupAnchor:new L.Point(0,4)}}),b=new a;kiezatlas.markers=new Array;for(var c=0;c<kiezatlas.mapTopics.result.topics.length;c++){var d=kiezatlas.mapTopics.result.topics[c],e=d.id,f=undefined,g=undefined,h=d.long,i=d.lat,j=!1;if(i==0||h==0)j=!0;else if(h<-180||h>180)j=!0;else if(i<-90||i>90)j=!0;else if(isNaN(i)||isNaN(h))j=!0;j||(g=new L.LatLng(parseFloat(i),parseFloat(h)));if(g!=undefined){var k=kiezatlas.getMarkerByLatLng(g);if(k!=null){f=k,f.options.topicId.push(e);var l=f._popup._content;f.bindPopup('<div id="'+e+'" onclick="kiezatlas.onBubbleClick(this)" class="topic-name item">'+'<b id="'+e+'">'+d.name+"</b>,&nbsp;...</div>"+l)}else f=new L.Marker(g,{clickable:!0,topicId:[e]}),f.bindPopup('<div id="'+e+'" onclick="kiezatlas.onBubbleClick(this)" class="topic-name item">'+'<b id="'+e+'">'+d.name+"</b>,&nbsp;...</div>");kiezatlas.map.addLayer(f),kiezatlas.markers.push(f),f.on("click",function(a){this._popup.options.autoPan=!0,this._popup.options.maxWidth=160,this._popup.options.closeButton=!0,this.openPopup()},f)}}console.log("map.setup => "+kiezatlas.markers.length+" leaflets for "+kiezatlas.mapTopics.result.topics.length+" loaded topics")},this.onBubbleClick=function(a){var b=a.id;kiezatlas.info(b)},this.getMarkerByLatLng=function(a){for(var b=0;b<kiezatlas.markers.length;b++){var c=kiezatlas.markers[b];if(c._latlng.equals(a))return c}return null},this.clearMarkers=function(){for(var a=0;a<kiezatlas.markers.length;a++){var b=kiezatlas.markers[a];try{kiezatlas.map.removeLayer(b)}catch(c){console.log("Exception: "+c)}}},this.getMarkersBounds=function(){var a=new L.LatLngBounds;for(var b=0;b<kiezatlas.markers.length;b++){var c=kiezatlas.markers[b],d=c._latlng.lng,e=c._latlng.lat,f=!1;if(e==0||d==0)f=!0;else if(d<-180||d>180)f=!0;else if(e<-90||e>90)f=!0;else if(isNaN(e)||isNaN(d))f=!0;if(!f){var g=new L.LatLng(parseFloat(e),parseFloat(d));a.extend(g)}}return a},this.getUsersLocation=function(a){a==undefined&&(a={setView:!0,maxZoom:kiezatlas.LEVEL_OF_KIEZ_ZOOM}),kiezatlas.map.locate(a),jQuery("img.loading").hide()},this.onLocationFound=function(a){var b=a.accuracy/2;kiezatlas.locationCircle!=undefined&&kiezatlas.map.removeLayer(kiezatlas.locationCircle),kiezatlas.locationCircle=new L.Circle(a.latlng,b,{stroke:!0,clickable:!1,color:"#1d1d1d",fillOpacity:.3,opacity:.3,weight:2}),kiezatlas.map.addLayer(kiezatlas.locationCircle,{clickable:!0}),kiezatlas.locationCircle.bindPopup("You are within "+b+" meters from this point"),kiezatlas.map.setView(a.latlng,kiezatlas.LEVEL_OF_KIEZ_ZOOM),jQuery("img.loading").hide()},this.onLocationError=function(a){console.log("hiding loading bar => "+jQuery("img.loading").css("display"))},this.showKiezatlasControl=function(){jQuery("a#go-more").click(kiezatlas.hideKiezatlasControl);var a=jQuery("#kiezatlas-control"),b='<ul class="ka-select">';b+='<li id="chbw" class="district-button">Charlottenburg-Wilmersdorf</li>',b+='<li id="fkreuz" class="district-button">Friedrichshain-Kreuzberg</li>',b+='<li id="lichtenberg" class="district-button">Lichtenberg (Hohensch&ouml;nhausen)</li>',b+='<li id="marzahn" class="district-button">Marzahn-Hellersdorf</li>',b+='<li id="mitte" class="district-button">Mitte (Tiergarten, Wedding)</li>',b+='<li id="neukoelln" class="district-button">Neuk&ouml;lln</li>',b+='<li id="pankow" class="district-button">Pankow (Prenzlauer Berg, Wei&szlig;ensee)</li>',b+='<li id="reinickendorf" class="district-button">Reinickendorf</li>',b+='<li id="spandau" class="district-button">Spandau</li>',b+='<li id="steglitz" class="district-button">Steglitz-Zehlendorf</li>',b+='<li id="tempelhof" class="district-button">Tempelhof-Sch&ouml;neberg</li>',b+='<li id="treptow" class="district-button">Treptow-K&ouml;penick</li>',b+="</ul>",a.html(b),a.show("fast"),a.click(function(a){a.stopPropagation(),kiezatlas.hideKiezatlasControl()}),jQuery(".district-button").click(kiezatlas.focusDistrict),kiezatlas.closeInfoContainer()},this.focusDistrict=function(a){var b=a.target.id,c=new L.LatLng(52.520979,13.407097),d=new L.LatLng(52.501814,13.432503),e=new L.LatLng(52.552257,13.43008),f=new L.LatLng(52.503916,13.283157),g=new L.LatLng(52.53734,13.168449),h=new L.LatLng(52.436781,13.24913),i=new L.LatLng(52.469629,13.383026),j=new L.LatLng(52.443478,13.446198),k=new L.LatLng(52.453522,13.56945),l=new L.LatLng(52.534417,13.565331),m=new L.LatLng(52.540473,13.502846),n=new L.LatLng(52.592424,13.326569);b=="mitte"?kiezatlas.map.setView(c,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="pankow"?kiezatlas.map.setView(e,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="fkreuz"?kiezatlas.map.setView(d,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="chbw"?kiezatlas.map.setView(f,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="spandau"?kiezatlas.map.setView(g,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="steglitz"?kiezatlas.map.setView(h,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="tempelhof"?kiezatlas.map.setView(i,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="neukoelln"?kiezatlas.map.setView(j,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="treptow"?kiezatlas.map.setView(k,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="marzahn"?kiezatlas.map.setView(l,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="lichtenberg"?kiezatlas.map.setView(m,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):b=="reinickendorf"&&kiezatlas.map.setView(n,kiezatlas.LEVEL_OF_DISTRICT_ZOOM),kiezatlas.hideKiezatlasControl()},this.hideKiezatlasControl=function(){jQuery("a#go-more").click(kiezatlas.showKiezatlasControl),jQuery("#kiezatlas-control").hide()},this.hideAddressBarThroughScrolling=function(){if(navigator.userAgent.match(/Android/i)){window.scrollTo(0,0);var a=$(document).height(),b=window.outerHeight;b>a&&(b/=window.devicePixelRatio,$("body").css("height",b+"px")),window.scrollTo(0,1)}},this.setMap=function(a){this.map=a,this.map.options.touchZoom=!0},this.setMapTopics=function(a){this.mapTopics=a},this.setCityMapId=function(a){this.cityMapId=a},this.setSelectedTopic=function(a){this.selectedTopic=a},this.setLayer=function(a){this.layer=a},this.setMapLayer=function(a){this.mapLayer=a},this.setSelectedCriteria=function(a){this.selectedCriteria=a},this.setWorkspaceCriterias=function(a){this.workspaceCriterias=a},this.setServerUrl=function(a){this.serverUrl=a},this.setServiceUrl=function(a){this.serviceUrl=a},this.setIconsFolder=function(a){this.iconsFolder=a},this.setImagesFolder=function(a){this.imagesFolder=a},this.setToCurrentBounds=function(){kiezatlas.markersBounds=kiezatlas.getMarkersBounds(),kiezatlas.map.fitBounds(kiezatlas.markersBounds)},this.popHistory=function(a){if(!this.historyApiSupported)return;a.name=="loaded"?kiezatlas.loadCityMap(a.parameter[0],a.parameter[1]):a.name=="info"&&kiezatlas.info(a.parameter)},this.pushHistory=function(a,b){if(!this.historyApiSupported)return;var c={state:a,url:b};window.history.pushState(c.state,null,c.url)},this.handleOrientationChange=function(a){var b=kiezatlas.windowHeight(),c=kiezatlas.windowWidth();b>c?(jQuery("#info-container").removeClass("info-container-panorama"),jQuery("#info-container").removeClass("info-container-panorama-big"),jQuery("#info-container").addClass("info-container-portrait"),jQuery("#map").removeClass("panorama-width-big"),jQuery("#map").removeClass("panorama-width"),jQuery("#map").addClass("portrait-height"),kiezatlas.panoramaOrientation=!1):b<c&&(jQuery("#info-container").removeClass("info-container-portrait"),c>810?(jQuery("#info-container").addClass("info-container-panorama-big"),jQuery("#map").addClass("panorama-width-big")):(jQuery("#info-container").addClass("info-container-panorama"),jQuery("#map").addClass("panorama-width")),jQuery("#map").removeClass("portrait-height"),kiezatlas.panoramaOrientation=!0)},this.windowHeight=function(){return self.innerHeight?self.innerHeight:document.documentElement&&document.documentElement.clientHeight?jQuery.clientHeight:document.body?document.body.clientHeight:0},this.windowWidth=function(){return self.innerWidth?self.innerWidth:document.documentElement&&document.documentElement.clientWidth?jQuery.clientWidth:document.body?document.body.clientWidth:0},this.stripFieldsContaining=function(a,b){var c=new Array;for(var d=0;d<a.properties.length;d++)a.properties[d].name.indexOf(b)==-1?c.push(a.properties[d]):a.properties[d].name.indexOf("Email")!=-1&&c.push(a.properties[d]);return a.properties=c,a},this.getTopicAddress=function(a){for(var b=0;b<a.properties.length;b++){if(a.properties[b].name=="Address / Street"&&a.properties[b].value!="")return a.properties[b].value;if(a.properties[b].name=="Straße"&&a.properties[b].value!="")return a.properties[b].value}return""},this.getImageSource=function(a){for(var b=0;b<a.properties.length;b++)if(a.properties[b].name=="Image / File"&&a.properties[b].value!="")return a.properties[b].value;return"undefined"},this.getTopicPostalCode=function(a){for(var b=0;b<a.properties.length;b++)if(a.properties[b].name=="Address / Postal Code")return a.properties[b].value;return""},this.getTopicOriginId=function(a){for(var b=0;b<a.properties.length;b++)if(a.properties[b].name=="OriginId")return a.properties[b].value;return""},this.getTopicCity=function(a){for(var b=0;b<a.properties.length;b++){if(a.properties[b].name=="Address / City")return a.properties[b].value;if(a.properties[b].name=="Stadt")return a.properties[b].value}return null},this.getLatLng=function(a){var b=undefined,c=undefined;for(var d=0;d<a.properties.length;d++)a.properties[d].name=="LAT"?b=a.properties[d].value:a.properties[d].name=="LONG"&&(c=a.properties[d].value);return new L.LatLng(b,c)},this.makeEhrenamtsLink=function(a,b){return urlMarkup='<a href="'+a+'" target="_blank">Link zur T&auml;tigkeitsbeschreibung</a>',urlMarkup},this.makeWebpageLink=function(a,b){return urlMarkup='<a href="'+a+'" target="_blank">'+b+"</a>",urlMarkup},this.makeEmailLink=function(a,b){return urlMarkup='<a href="mailto:'+a+'" target="_blank">'+b+"</a>",urlMarkup},this.getCategory=function(a){var b={};for(var c=0;c<this.workspaceCriterias.result[this.selectedCriteria].categories.length;c++){var d=this.workspaceCriterias.result[""+this.selectedCriteria+""].categories[c].catId;if(d==a)return b.icon=this.workspaceCriterias.result[""+this.selectedCriteria+""].categories[c].catIcon,b.name=this.workspaceCriterias.result[""+this.selectedCriteria+""].categories[c].catName,b}return null}};