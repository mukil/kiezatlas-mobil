/** 
 * This is some KiezatlasJS citymap client designed to run on all major mobile screens.
 * @author  Malte Rei&szlig;ig (rma@mikromedia.de), Copyright (c) 2012
 * @license   GPLv3
 * 
 * @requires  jQuery JavaScript Library v1.5.2, Copyright 2011, John Resig
              Dual licensed under the MIT or GPL Version 2 licenses.(http://jquery.org/license)
 * @requires  leaflet.js, Copyright (c) 2010-2012, CloudMade, Vladimir Agafonkin, All rights reserved.
 *            Used in version/with source code at https://github.com/mukil/Leaflet
 * @requires  iscroll.js v4.1.9 ~ Copyright (c) 2011 Matteo Spinelli, http://cubiq.org
 *            Released under MIT license, (http://cubiq.org/license)
* 
 * @modified  02.July 2012
 */var SERVER_URL="http://www.kiezatlas.de",SERVICE_URL=SERVER_URL+"/rpc/",ICONS_URL="http://www.kiezatlas.de/client/icons/",IMAGES_URL="http://www.kiezatlas.de/client/images/",baseUrl=SERVER_URL+"/maps/mobile/",permaLink="",linkParams=[],kiezatlas=new function(){this.mapTopics=undefined,this.workspaceCriterias=undefined,this.cityMapId=undefined,this.workspaceId=undefined,this.defaultMapCenter=undefined,this.markersBounds=undefined,this.locationCircle=undefined,this.mapLayer=undefined,this.map=undefined,this.serverUrl=undefined,this.serviceUrl=undefined,this.iconsFolder=undefined,this.imagesFolder=undefined,this.markers=undefined,this.LEVEL_OF_DETAIL_ZOOM=15,this.LEVEL_OF_STREET_ZOOM=14,this.LEVEL_OF_KIEZ_ZOOM=13,this.LEVEL_OF_DISTRICT_ZOOM=12,this.LEVEL_OF_CITY_ZOOM=11,this.layer=undefined,this.historyApiSupported=window.history.pushState,this.panoramaOrientation=undefined,this.myScroll=undefined,this.renderSite=function(){var e='<a class="leaflet-control-zoom-loc" href="#" title="Your Location"></a>',t='<a id="go-more" title="Bezirksauswahl" alt="Bezirksauswahl"href="#"></a>';kiezatlas.map.on("locationfound",kiezatlas.onLocationFound),kiezatlas.map.on("locationerror",kiezatlas.onLocationError),jQuery(e).insertBefore(".leaflet-control-zoom-in"),jQuery(t).insertBefore(".leaflet-control-zoom-loc"),jQuery(".leaflet-control-zoom-loc").click(kiezatlas.getUsersLocation),jQuery("a#go-more").click(kiezatlas.showKiezatlasControl),jQuery(window).resize(kiezatlas.handleOrientationChange),kiezatlas.hideAddressBarThroughScrolling()},this.loadCityMap=function(e,t){kiezatlas.cityMapId=e,kiezatlas.workspaceId=t,kiezatlas.markers!=undefined&&kiezatlas.clearMarkers(),jQuery("img.loading").css("display","block"),console.log("showing loading bar => "+jQuery("img.loading").css("display")),kiezatlas.loadCityMapTopics(e,t,function(){kiezatlas.setupLeafletMarkers(),kiezatlas.setToCurrentBounds(),kiezatlas.getUsersLocation()}),kiezatlas.closeInfoContainer(),cityMapEhrenamtId!=undefined&&cityMapEventId!=undefined&&(kiezatlas.cityMapId==cityMapEhrenamtId?(jQuery("#go-do").addClass("selected"),jQuery("#go-event").removeClass("selected")):kiezatlas.cityMapId==cityMapEventId&&(jQuery("#go-event").addClass("selected"),jQuery("#go-do").removeClass("selected"))),kiezatlas.hideKiezatlasControl()},this.loadCityMapTopics=function(e,t,n){var r=baseUrl+"getCityMap.php?mapId="+e+"&workspaceId="+t,i='{"method": "getMapTopics", "params": ["'+e+'" , "'+t+'"]}';jQuery.ajax({type:"GET",async:!1,url:r,dataType:"json",beforeSend:function(e){e.setRequestHeader("Content-Type","application/json")},success:function(e){kiezatlas.setMapTopics(e),n()},error:function(e,t,n){throw new Error("Error while loading city-map. Message: "+JSON.stringify(e))}})},this.info=function(e){kiezatlas.loadCityObjectInfo(e,kiezatlas.renderInfo)},this.loadCityObjectInfo=function(e,t){var n=baseUrl+"getGeoObjectInfo.php?topicId="+e;jQuery.ajax({type:"GET",async:!1,url:n,dataType:"json",beforeSend:function(e){e.setRequestHeader("Content-Type","application/json")},success:function(e){t(e.result)},error:function(e,t,n){throw new Error("ERROR: detailed information on this point could not be loaded. please try again. "+e)}})},this.renderInfo=function(e){jQuery("#close-button").show(),jQuery("#down-button").show();var t='<div id="info-table">';t+='<h3 class="title">'+e.name+"</h3></div>";var n="",r=kiezatlas.getTopicAddress(e),i=kiezatlas.getTopicPostalCode(e),s=kiezatlas.getTopicCity(e),o=kiezatlas.getLatLng(e);s==undefined&&(s="Berlin");if(s==" Berlin"||s=="Berlin"){var u=r+"%20"+i+"%20"+s,a="http://www.fahrinfo-berlin.de/fahrinfo/bin/query.exe/d?Z="+u+"&REQ0JourneyStopsZA1=2&start=1",f='<a href="'+a+'" target="_blank">'+'<img class="fahrinfo" src="'+kiezatlas.imagesFolder+'fahrinfo.gif" border="0" hspace="20"/></a>';n='<div id="info-item"><span class="content">'+r+", "+i+" "+s+f+"</span><br/>"}else n='<div id="info-item"><span class="content">'+r+", "+i+" "+s+"</span><br/>";e=kiezatlas.stripFieldsContaining(e,"LAT"),e=kiezatlas.stripFieldsContaining(e,"LONG"),e=kiezatlas.stripFieldsContaining(e,"Locked Geometry"),e=kiezatlas.stripFieldsContaining(e,"Forum / Aktivierung"),e=kiezatlas.stripFieldsContaining(e,"Image"),e=kiezatlas.stripFieldsContaining(e,"Icon"),e=kiezatlas.stripFieldsContaining(e,"YADE"),e=kiezatlas.stripFieldsContaining(e,"Name"),e=kiezatlas.stripFieldsContaining(e,"Description"),e=kiezatlas.stripFieldsContaining(e,"Timestamp"),e=kiezatlas.stripFieldsContaining(e,"OriginId"),e=kiezatlas.stripFieldsContaining(e,"Administrator Infos"),e=kiezatlas.stripFieldsContaining(e,"Address"),e=kiezatlas.stripFieldsContaining(e,"Stadt");var l="";for(var c=0;c<e.properties.length;c++){e.properties[c].label.indexOf("Sonstiges")==-1&&e.properties[c].label.indexOf("Administrator")==-1&&(e.properties[c].label!="Barrierefrei"||e.properties[c].value!="")&&e.properties[c].value!=""&&(l+="<br/>"+e.properties[c].label+":&nbsp;");if(e.properties[c].type==0)e.properties[c].label.indexOf("Barrierefrei")==-1?l+="<b>"+e.properties[c].value+"</b>":e.properties[c].value!=""&&(e.properties[c].value=="Ja"?l+="<b>Ja Rollstuhlgerecht</b></p>":e.properties[c].value.indexOf("Eingeschr")!=-1?l+="<b>Eingeschr&auml;nkt Rollstuhlgerecht</b></p>":e.properties[c].value=="Nein"?l+="<b>Nicht Rollstuhlgerecht</b></p>":l+="<b>"+e.properties[c].value+"</b><p/>");else{var h="";l+="";for(var p=0;p<e.properties[c].values.length;p++)value=e.properties[c].values[p].name,e.properties[c].name=="Person"?l+="<b>"+value+"</b>&nbsp;":e.properties[c].name=="Webpage"?(value=kiezatlas.makeEhrenamtsLink(value,value),l+="<b>"+value+"</b>&nbsp;"):l+="<b>"+value+"</b>&nbsp;";l+="<br/>"}}n+=l,n+="</p></div>",jQuery("#scroller").html(t),jQuery("#scroller").append(n),kiezatlas.showInfoContainer(),kiezatlas.myScroll!=undefined&&(kiezatlas.myScroll.destroy(),kiezatlas.myScroll=null),kiezatlas.myScroll=new iScroll("info-container",{momentum:!0,hScrollbar:!1,vScrollbar:!0,hideScrollbar:!1,justScrolled:function(){jQuery("#top-button").show()},justReset:function(){jQuery("#top-button").hide()}}),kiezatlas.map.panTo(o)},this.showInfoContainer=function(){jQuery("#info-container").hide(),jQuery("#top-button").hide(),jQuery("#navigation").hide(),jQuery(".leaflet-control-zoom.leaflet-control").css("margin-top",0),kiezatlas.handleOrientationChange(),jQuery("#map").removeClass("fullsize"),kiezatlas.map.invalidateSize(),jQuery("#info-container").click(function(e){e.stopPropagation()}),jQuery("#info-container").show()},this.closeInfoContainer=function(){jQuery("#navigation").show(),jQuery(".leaflet-control-zoom.leaflet-control").css("margin-top",50),kiezatlas.handleOrientationChange(),jQuery("#map").addClass("fullsize"),kiezatlas.map.invalidateSize(),jQuery("#info-container").hide()},this.scrollInfoDown=function(){kiezatlas.myScroll.scrollTo(0,75,200,!0)},this.scrollInfoTop=function(){kiezatlas.myScroll.scrollTo(0,0,200,!0)},this.toggleInfoItem=function(e){var t=e.currentTarget.offsetParent.children[2].id;jQuery("#"+t).toggle()},this.setupLeafletMarkers=function(){var e=L.Icon.extend({options:{iconUrl:"css/locationPointer.png",shadowUrl:null,iconSize:new L.Point(40,40),shadowSize:null,iconAnchor:new L.Point(20,14),popupAnchor:new L.Point(0,4)}}),t=new e;kiezatlas.markers=new Array;for(var n=0;n<kiezatlas.mapTopics.result.topics.length;n++){var r=kiezatlas.mapTopics.result.topics[n],i=r.id,s=undefined,o=undefined,u=r.long,a=r.lat,f=!1;if(a==0||u==0)f=!0;else if(u<-180||u>180)f=!0;else if(a<-90||a>90)f=!0;else if(isNaN(a)||isNaN(u))f=!0;f||(o=new L.LatLng(parseFloat(a),parseFloat(u)));if(o!=undefined){var l=kiezatlas.getMarkerByLatLng(o);if(l!=null){s=l,s.options.topicId.push(i);var c=s._popup._content;s.bindPopup('<div id="'+i+'" onclick="kiezatlas.onBubbleClick(this)" class="topic-name item">'+'<b id="'+i+'">'+r.name+"</b>,&nbsp;...</div>"+c)}else s=new L.Marker(o,{clickable:!0,topicId:[i]}),s.bindPopup('<div id="'+i+'" onclick="kiezatlas.onBubbleClick(this)" class="topic-name item">'+'<b id="'+i+'">'+r.name+"</b>,&nbsp;...</div>");kiezatlas.map.addLayer(s),kiezatlas.markers.push(s),s.on("click",function(e){this._popup.options.autoPan=!0,this._popup.options.maxWidth=160,this._popup.options.closeButton=!0,this.openPopup()},s)}}console.log("map.setup => "+kiezatlas.markers.length+" leaflets for "+kiezatlas.mapTopics.result.topics.length+" loaded topics")},this.onBubbleClick=function(e){var t=e.id;kiezatlas.info(t)},this.getMarkerByLatLng=function(e){for(var t=0;t<kiezatlas.markers.length;t++){var n=kiezatlas.markers[t];if(n._latlng.equals(e))return n}return null},this.clearMarkers=function(){for(var e=0;e<kiezatlas.markers.length;e++){var t=kiezatlas.markers[e];try{kiezatlas.map.removeLayer(t)}catch(n){console.log("Exception: "+n)}}},this.getMarkersBounds=function(){var e=new L.LatLngBounds;for(var t=0;t<kiezatlas.markers.length;t++){var n=kiezatlas.markers[t],r=n._latlng.lng,i=n._latlng.lat,s=!1;if(i==0||r==0)s=!0;else if(r<-180||r>180)s=!0;else if(i<-90||i>90)s=!0;else if(isNaN(i)||isNaN(r))s=!0;if(!s){var o=new L.LatLng(parseFloat(i),parseFloat(r));e.extend(o)}}return e},this.getUsersLocation=function(e){e==undefined&&(e={setView:!0,maxZoom:kiezatlas.LEVEL_OF_KIEZ_ZOOM}),kiezatlas.map.locate(e),jQuery("img.loading").hide()},this.onLocationFound=function(e){var t=e.accuracy/2;kiezatlas.locationCircle!=undefined&&kiezatlas.map.removeLayer(kiezatlas.locationCircle),kiezatlas.locationCircle=new L.Circle(e.latlng,t,{stroke:!0,clickable:!1,color:"#1d1d1d",fillOpacity:.3,opacity:.3,weight:2}),kiezatlas.map.addLayer(kiezatlas.locationCircle,{clickable:!0}),kiezatlas.locationCircle.bindPopup("You are within "+t+" meters from this point"),kiezatlas.map.setView(e.latlng,kiezatlas.LEVEL_OF_KIEZ_ZOOM),jQuery("img.loading").hide()},this.onLocationError=function(e){console.log("hiding loading bar => "+jQuery("img.loading").css("display"))},this.showKiezatlasControl=function(){jQuery("a#go-more").click(kiezatlas.hideKiezatlasControl);var e=jQuery("#kiezatlas-control"),t='<ul class="ka-select">';t+='<li id="chbw" class="district-button">Charlottenburg-Wilmersdorf</li>',t+='<li id="fkreuz" class="district-button">Friedrichshain-Kreuzberg</li>',t+='<li id="lichtenberg" class="district-button">Lichtenberg (Hohensch&ouml;nhausen)</li>',t+='<li id="marzahn" class="district-button">Marzahn-Hellersdorf</li>',t+='<li id="mitte" class="district-button">Mitte (Tiergarten, Wedding)</li>',t+='<li id="neukoelln" class="district-button">Neuk&ouml;lln</li>',t+='<li id="pankow" class="district-button">Pankow (Prenzlauer Berg, Wei&szlig;ensee)</li>',t+='<li id="reinickendorf" class="district-button">Reinickendorf</li>',t+='<li id="spandau" class="district-button">Spandau</li>',t+='<li id="steglitz" class="district-button">Steglitz-Zehlendorf</li>',t+='<li id="tempelhof" class="district-button">Tempelhof-Sch&ouml;neberg</li>',t+='<li id="treptow" class="district-button">Treptow-K&ouml;penick</li>',t+="</ul>",e.html(t),e.show("fast"),e.click(function(e){e.stopPropagation(),kiezatlas.hideKiezatlasControl()}),jQuery(".district-button").click(kiezatlas.focusDistrict),kiezatlas.closeInfoContainer()},this.focusDistrict=function(e){var t=e.target.id,n=new L.LatLng(52.520979,13.407097),r=new L.LatLng(52.501814,13.432503),i=new L.LatLng(52.552257,13.43008),s=new L.LatLng(52.503916,13.283157),o=new L.LatLng(52.53734,13.168449),u=new L.LatLng(52.436781,13.24913),a=new L.LatLng(52.469629,13.383026),f=new L.LatLng(52.443478,13.446198),l=new L.LatLng(52.453522,13.56945),c=new L.LatLng(52.534417,13.565331),h=new L.LatLng(52.540473,13.502846),p=new L.LatLng(52.592424,13.326569);t=="mitte"?kiezatlas.map.setView(n,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="pankow"?kiezatlas.map.setView(i,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="fkreuz"?kiezatlas.map.setView(r,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="chbw"?kiezatlas.map.setView(s,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="spandau"?kiezatlas.map.setView(o,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="steglitz"?kiezatlas.map.setView(u,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="tempelhof"?kiezatlas.map.setView(a,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="neukoelln"?kiezatlas.map.setView(f,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="treptow"?kiezatlas.map.setView(l,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="marzahn"?kiezatlas.map.setView(c,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="lichtenberg"?kiezatlas.map.setView(h,kiezatlas.LEVEL_OF_DISTRICT_ZOOM):t=="reinickendorf"&&kiezatlas.map.setView(p,kiezatlas.LEVEL_OF_DISTRICT_ZOOM),kiezatlas.hideKiezatlasControl()},this.hideKiezatlasControl=function(){jQuery("a#go-more").click(kiezatlas.showKiezatlasControl),jQuery("#kiezatlas-control").hide()},this.hideAddressBarThroughScrolling=function(){if(navigator.userAgent.match(/Android/i)){window.scrollTo(0,0);var e=$(document).height(),t=window.outerHeight;t>e&&(t/=window.devicePixelRatio,$("body").css("height",t+"px")),window.scrollTo(0,1)}},this.setMap=function(e){this.map=e,this.map.options.touchZoom=!0},this.setMapTopics=function(e){this.mapTopics=e},this.setCityMapId=function(e){this.cityMapId=e},this.setSelectedTopic=function(e){this.selectedTopic=e},this.setLayer=function(e){this.layer=e},this.setMapLayer=function(e){this.mapLayer=e},this.setSelectedCriteria=function(e){this.selectedCriteria=e},this.setWorkspaceCriterias=function(e){this.workspaceCriterias=e},this.setServerUrl=function(e){this.serverUrl=e},this.setServiceUrl=function(e){this.serviceUrl=e},this.setIconsFolder=function(e){this.iconsFolder=e},this.setImagesFolder=function(e){this.imagesFolder=e},this.setToCurrentBounds=function(){kiezatlas.markersBounds=kiezatlas.getMarkersBounds(),kiezatlas.map.fitBounds(kiezatlas.markersBounds)},this.popHistory=function(e){if(!this.historyApiSupported)return;e.name=="loaded"?kiezatlas.loadCityMap(e.parameter[0],e.parameter[1]):e.name=="info"&&kiezatlas.info(e.parameter)},this.pushHistory=function(e,t){if(!this.historyApiSupported)return;var n={state:e,url:t};window.history.pushState(n.state,null,n.url)},this.handleOrientationChange=function(e){var t=kiezatlas.windowHeight(),n=kiezatlas.windowWidth();t>n?(jQuery("#info-container").removeClass("info-container-panorama"),jQuery("#info-container").removeClass("info-container-panorama-big"),jQuery("#info-container").addClass("info-container-portrait"),jQuery("#map").removeClass("panorama-width-big"),jQuery("#map").removeClass("panorama-width"),jQuery("#map").addClass("portrait-height"),kiezatlas.panoramaOrientation=!1):t<n&&(jQuery("#info-container").removeClass("info-container-portrait"),n>810?(jQuery("#info-container").addClass("info-container-panorama-big"),jQuery("#map").addClass("panorama-width-big")):(jQuery("#info-container").addClass("info-container-panorama"),jQuery("#map").addClass("panorama-width")),jQuery("#map").removeClass("portrait-height"),kiezatlas.panoramaOrientation=!0)},this.windowHeight=function(){return self.innerHeight?self.innerHeight:document.documentElement&&document.documentElement.clientHeight?jQuery.clientHeight:document.body?document.body.clientHeight:0},this.windowWidth=function(){return self.innerWidth?self.innerWidth:document.documentElement&&document.documentElement.clientWidth?jQuery.clientWidth:document.body?document.body.clientWidth:0},this.stripFieldsContaining=function(e,t){var n=new Array;for(var r=0;r<e.properties.length;r++)e.properties[r].name.indexOf(t)==-1?n.push(e.properties[r]):e.properties[r].name.indexOf("Email")!=-1&&n.push(e.properties[r]);return e.properties=n,e},this.getTopicAddress=function(e){for(var t=0;t<e.properties.length;t++){if(e.properties[t].name=="Address / Street"&&e.properties[t].value!="")return e.properties[t].value;if(e.properties[t].name=="Straße"&&e.properties[t].value!="")return e.properties[t].value}return""},this.getImageSource=function(e){for(var t=0;t<e.properties.length;t++)if(e.properties[t].name=="Image / File"&&e.properties[t].value!="")return e.properties[t].value;return"undefined"},this.getTopicPostalCode=function(e){for(var t=0;t<e.properties.length;t++)if(e.properties[t].name=="Address / Postal Code")return e.properties[t].value;return""},this.getTopicOriginId=function(e){for(var t=0;t<e.properties.length;t++)if(e.properties[t].name=="OriginId")return e.properties[t].value;return""},this.getTopicCity=function(e){for(var t=0;t<e.properties.length;t++){if(e.properties[t].name=="Address / City")return e.properties[t].value;if(e.properties[t].name=="Stadt")return e.properties[t].value}return null},this.getLatLng=function(e){var t=undefined,n=undefined;for(var r=0;r<e.properties.length;r++)e.properties[r].name=="LAT"?t=e.properties[r].value:e.properties[r].name=="LONG"&&(n=e.properties[r].value);return new L.LatLng(t,n)},this.makeEhrenamtsLink=function(e,t){return urlMarkup='<a href="'+e+'" target="_blank">Link zur T&auml;tigkeitsbeschreibung</a>',urlMarkup},this.makeWebpageLink=function(e,t){return urlMarkup='<a href="'+e+'" target="_blank">'+t+"</a>",urlMarkup},this.makeEmailLink=function(e,t){return urlMarkup='<a href="mailto:'+e+'" target="_blank">'+t+"</a>",urlMarkup},this.getCategory=function(e){var t={};for(var n=0;n<this.workspaceCriterias.result[this.selectedCriteria].categories.length;n++){var r=this.workspaceCriterias.result[""+this.selectedCriteria+""].categories[n].catId;if(r==e)return t.icon=this.workspaceCriterias.result[""+this.selectedCriteria+""].categories[n].catIcon,t.name=this.workspaceCriterias.result[""+this.selectedCriteria+""].categories[n].catName,t}return null}};